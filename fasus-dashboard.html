<!DOCTYPE html>
<html lang="id">

<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Dashboard Fasus</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

body{
margin:0;
font-family:Arial;
background:#0b0b0b;
color:white;
}

/* HEADER */

.header{
background:#FFD100;
color:black;
padding:18px;
font-size:24px;
font-weight:bold;
display:flex;
justify-content:space-between;
align-items:center;
position:relative;
}

.header-left{
z-index:1;
}

.header-center{
position:absolute;
left:50%;
transform:translateX(-50%);
}

.header-right{
font-size:16px;
}

.logo{
height:50px;
}

/* BACK BUTTON */

.back{
margin:15px;
padding:10px 20px;
background:#FFD100;
border:none;
cursor:pointer;
font-weight:bold;
}

/* CONTENT */

.container{
padding:20px;
}

.card{
background:#1a1a1a;
padding:20px;
border-radius:10px;
margin-bottom:20px;
}

.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:20px;
}

table{
width:100%;
border-collapse:collapse;
}

th{
background:#FFD100;
color:black;
padding:10px;
}

td{
padding:10px;
border-bottom:1px solid #333;
}

/* SPINNER */

.spinner{
position:fixed;
width:100%;
height:100%;
background:rgba(0,0,0,0.7);
display:flex;
justify-content:center;
align-items:center;
z-index:10;
}

.loader{
border:8px solid #333;
border-top:8px solid #FFD100;
border-radius:50%;
width:70px;
height:70px;
animation:spin 1s linear infinite;
}

@keyframes spin{
0%{transform:rotate(0deg);}
100%{transform:rotate(360deg);}
}

</style>

</head>

<body>

<div id="spinner" class="spinner">
<div class="loader"></div>
</div>

<div class="header">

<div class="header-left" id="title">
Dashboard
</div>

<div class="header-center">
<img src="ut-school-logo.png" class="logo">
</div>

<div class="header-right" id="updated">
Last updated
</div>

</div>

<button class="back"
onclick="window.location.href='index.html'">
‚Üê Back
</button>

<div class="container" id="content" style="display:none;">

<div class="grid">

<div class="card">

<h3>Financial Summary</h3>

<p>Total Budget:
<span id="total"></span></p>

<p>Terpakai:
<span id="used"></span></p>

<p>Tersisa:
<span id="remaining"></span></p>

</div>

<div class="card">
<canvas id="pie"></canvas>
</div>

</div>

<div class="card">
<canvas id="bar"></canvas>
</div>

<div class="card">

<h3>Detail List</h3>

<table>

<thead>
<tr>
<th>PJB</th>
<th>Serial</th>
<th>Expired</th>
<th>Status</th>
<th>Amount</th>
</tr>
</thead>

<tbody id="table"></tbody>

</table>

</div>

</div>

<script>

const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTbJYRkPPTPDYHrDTy-eA_e5rUZ_VowdvBDjHU0BD7rKTvHIZfZAQf_ctl8qDkpiGYVnr9qARdX4fZ6/gviz/tq?tqx=out:json&gid=969077332";

function rupiah(n){

return "Rp " + Number(n).toLocaleString("id-ID");

}

const params =
new URLSearchParams(window.location.search);

const fasus =
params.get("fasus");

document.getElementById("title").innerText =
fasus + " Dashboard";

fetch(SHEET_URL)

.then(res=>res.text())

.then(text=>{

const json =
JSON.parse(text.substring(47).slice(0,-2));

const rows =
json.table.rows;

const data =
rows.map(r=>({

fasus: r.c[0]?.v || "",

amount: Number(r.c[1]?.v || 0),

status: r.c[2]?.v || "",

pjb: r.c[3]?.v || "",

serial: r.c[4]?.v || "",

expired: r.c[5]?.v || ""

}));

const filtered =
data.filter(d =>
d.fasus.toLowerCase() === fasus.toLowerCase()
);

let total=0;
let used=0;

filtered.forEach(d=>{

total += d.amount;

if(d.status==="DONE")
used += d.amount;

document.getElementById("table").innerHTML +=

`<tr>
<td>${d.pjb}</td>
<td>${d.serial}</td>
<td>${d.expired}</td>
<td>${d.status}</td>
<td>${rupiah(d.amount)}</td>
</tr>`;

});

const remaining =
total - used;

document.getElementById("total").innerText =
rupiah(total);

document.getElementById("used").innerText =
rupiah(used);

document.getElementById("remaining").innerText =
rupiah(remaining);

document.getElementById("updated").innerText =
"Last updated: " +
new Date().toLocaleString();

new Chart(document.getElementById("pie"),{

type:"pie",

data:{
labels:["Terpakai","Tersisa"],
datasets:[{
data:[used,remaining],
backgroundColor:["#ff3b3b","#00c853"]
}]
}

});

let doneCount=0;
let notYetCount=0;

filtered.forEach(d=>{

if(d.status==="DONE")
doneCount++;
else
notYetCount++;

});

new Chart(document.getElementById("bar"),{

type:"bar",

data:{
labels:["DONE","NOT YET"],
datasets:[{
data:[doneCount,notYetCount],
backgroundColor:["#00c853","#FFD100"]
}]
}

});

document.getElementById("spinner").style.display="none";

document.getElementById("content").style.display="block";

})

.catch(err=>{

alert("Gagal mengambil data dari spreadsheet");

});

</script>

</body>
</html>
