<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Dashboard Fasus</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

body{
margin:0;
font-family:Arial;
background:#0b0b0b;
color:white;
}

/* LOGO */
.logo-container{
text-align:center;
padding-top:20px;
padding-bottom:10px;
background:#0b0b0b;
}

.logo-ut{
height:70px;
object-fit:contain;
}

/* HEADER */
.header{
background:#FFD100;
color:black;
padding:18px;
font-size:24px;
font-weight:bold;
display:flex;
justify-content:space-between;
align-items:center;
}

/* BACK BUTTON */
.back{
margin:15px;
padding:10px 20px;
background:#FFD100;
border:none;
cursor:pointer;
font-weight:bold;
}

/* CONTENT */
.container{
padding:20px;
}

.card{
background:#1a1a1a;
padding:20px;
border-radius:10px;
margin-bottom:20px;
}

.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:20px;
}

/* TABLE */
table{
width:100%;
border-collapse:collapse;
}

th{
background:#FFD100;
color:black;
padding:10px;
}

td{
padding:10px;
border-bottom:1px solid #333;
}

/* SPINNER */
.spinner{
position:fixed;
width:100%;
height:100%;
background:rgba(0,0,0,0.7);
display:flex;
justify-content:center;
align-items:center;
z-index:10;
}

.loader{
border:8px solid #333;
border-top:8px solid #FFD100;
border-radius:50%;
width:70px;
height:70px;
animation:spin 1s linear infinite;
}

@keyframes spin{
0%{transform:rotate(0deg);}
100%{transform:rotate(360deg);}
}

/* LAST UPDATED */
.lastUpdated{
color:#aaa;
margin-bottom:15px;
}

</style>
</head>

<body>

<!-- LOGO -->
<div class="logo-container">
<img src="logo-ut.png" class="logo-ut">
</div>

<!-- SPINNER -->
<div id="spinner" class="spinner">
<div class="loader"></div>
</div>

<!-- HEADER -->
<div class="header">
<div id="title">Dashboard</div>
<div id="lastUpdated"></div>
</div>

<!-- BACK BUTTON -->
<button class="back"
onclick="window.location.href='index.html'">
‚Üê Back
</button>

<!-- CONTENT -->
<div class="container" id="content" style="display:none;">

<div class="grid">

<div class="card">

<h3>Financial Summary</h3>

<p>Total Budget:
<span id="total">Rp 0</span></p>

<p>Terpakai:
<span id="used">Rp 0</span></p>

<p>Tersisa:
<span id="remaining">Rp 0</span></p>

</div>

<div class="card">

<canvas id="pie"></canvas>

</div>

</div>

<div class="card">

<canvas id="bar"></canvas>

</div>

<div class="card">

<h3>Detail List</h3>

<table>

<thead>
<tr>
<th>PJB</th>
<th>Serial</th>
<th>Expired</th>
<th>Sisa</th>
<th>Status</th>
</tr>
</thead>

<tbody id="table"></tbody>

</table>

</div>

</div>

<script>

function formatRupiah(num){
return "Rp "+Number(num).toLocaleString("id-ID");
}

const params=new URLSearchParams(window.location.search);

const fasus=params.get("fasus");

document.getElementById("title").innerText=
fasus+" Dashboard";

/* CALL N8N WEBHOOK */
fetch(
"https://dummyacountsubhan1.app.n8n.cloud/webhook/check-budget",
{
method:"POST",
headers:{
"Content-Type":"application/json"
},
body:JSON.stringify({fasus})
}
)
.then(res=>res.json())
.then(data=>{

/* STOP SPINNER */
document.getElementById("spinner").style.display="none";
document.getElementById("content").style.display="block";

/* LAST UPDATED */
document.getElementById("lastUpdated").innerText=
"Last updated: "+
new Date(data.last_updated).toLocaleString();

/* SUMMARY */
document.getElementById("total").innerText=
formatRupiah(data.summary.total_budget);

document.getElementById("used").innerText=
formatRupiah(data.summary.total_used);

document.getElementById("remaining").innerText=
formatRupiah(data.summary.total_remaining);

/* PIE CHART */
new Chart(document.getElementById("pie"),{
type:"pie",
data:{
labels:["Terpakai","Tersisa"],
datasets:[{
data:[
data.summary.total_used,
data.summary.total_remaining
],
backgroundColor:[
"#FFD100",
"#444"
]
}]
}
});

/* TABLE AND BAR */
let done=0;
let notyet=0;

data.details.forEach(d=>{

if(d.status==="DONE")
done++;
else
notyet++;

document.getElementById("table").innerHTML+=
`<tr>
<td>${d.pjb}</td>
<td>${d.serial}</td>
<td>${d.expired}</td>
<td>${formatRupiah(d.sisa)}</td>
<td>${d.status}</td>
</tr>`;

});

/* BAR CHART */
new Chart(document.getElementById("bar"),{
type:"bar",
data:{
labels:["DONE","NOT YET"],
datasets:[{
data:[done,notyet],
backgroundColor:[
"#FFD100",
"#555"
]
}]
}
});

})
.catch(err=>{
document.getElementById("spinner").style.display="none";
alert("Gagal load data dari server");
console.log(err);
});

</script>

</body>
</html>
